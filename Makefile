# get the normalized current directory
THIS_DIR := $(shell pwd)

# Default to a Debug build. If you want to enable debugging flags, run
# "make BUILD_TYPE=Release"
BUILD_TYPE ?= Debug
ifneq "$(BUILD_TYPE)" "Debug"
    ifneq "$(BUILD_TYPE)" "Release"
        $(error Bad BUILD_TYPE value "$(BUILD_TYPE)" please use "Debug" or "Release")
    endif
endif
BUILD_TYPE_LOWER := $(shell echo $(BUILD_TYPE) | tr A-Z a-z)


# Figure out where to build the software. Use BUILD_PREFIX if it was passed in.
BUILD_PREFIX ?= $(THIS_DIR)/build/$(BUILD_TYPE_LOWER)


BUILD_TOOL ?= ninja
ifneq "$(BUILD_TOOL)" "ninja"
    ifneq "$(BUILD_TOOL)" "make"
        $(error Bad BUILD_TOOL value "$(BUILD_TOOL)" please use "ninaj" or "make")
    endif
endif

CMAKE_GENERATOR ?= Ninja
BUILD_FILE ?= build.ninja
ifeq "$(BUILD_TOOL)" "make"
    BUILD_FILE ?= Makefile
    CMAKE_GENERATOR ?= "Unix Makefiles"
endif

# Get number of jobs Make is being called with. This only works with '-j' and not --jobs'
BUILD_TOOL_PID := $(shell echo $$PPID)
JOB_FLAG := $(filter -j%, $(subst -j ,-j,$(shell ps T | grep "^\s*$(BUILD_TOOL_PID).*$(BUILD_TOOL)")))
JOBS := $(subst -j,,$(JOB_FLAG))
# ifeq "$(JOBS)" ""
#    JOBS := 1
# endif

INSTALL_PREFIX ?= $(shell echo $(THIS_DIR)/build/$(BUILD_TYPE_LOWER)/install )

# Default to a Debug build. If you want to enable debugging flags, run
# "make BUILD_TYPE=Release"
CLANG_TIDY_FIX ?= OFF
ifneq "$(CLANG_TIDY_FIX)" "ON"
    ifneq "$(CLANG_TIDY_FIX)" "OFF"
        $(error Bad CLANG_TIDY_FIX value "$(CLANG_TIDY_FIX)" please use "ON" or "OFF")
    endif
endif

ifeq "$(CMAKE_OPTIONS)" ""
    CMAKE_OPTIONS := -G Ninja -DCLANG_TIDY_FIX=$(CLANG_TIDY_FIX) -DCMAKE_INSTALL_PREFIX=$(INSTALL_PREFIX) -DCMAKE_BUILD_TYPE=$(BUILD_TYPE)
else
   # force cmake to be re-run if we change the cmake options
   $(shell rm $(BUILD_PREFIX)/$(BUILD_FILE))
endif


$(BUILD_PREFIX)/$(BUILD_FILE):
	# create the temporary build directory if needed
	mkdir -p $(BUILD_PREFIX)
	touch -c $@
	# run CMake to generate and configure the build scripts
	ln -sf $(BUILD_PREFIX)/compile_commands.json compile_commands.json && \
	cd $(BUILD_PREFIX) && \
	cmake ../.. $(CMAKE_OPTIONS); \

.PHONY: rm_cache
rm_cache:
	rm $(BUILD_PREFIX)/CMakeCache.txt

# Other (custom) targets are passed through to the cmake-generated $(BUILD_FILE)
# Note: when no targets are passed from the commanding the special variable $@
# is "Makefile" so we need to angle this odd case differently.
%: $(BUILD_PREFIX)/$(BUILD_FILE)
	@set -o xtrace; \
	export CTEST_OUTPUT_ON_FAILURE=1; \
	if [ $@ = Makefile ]; then \
		$(BUILD_TOOL) -C $(BUILD_PREFIX) -- ${ARGS}; \
	else \
		$(BUILD_TOOL) -C $(BUILD_PREFIX) $@ -- ${ARGS}; \
	fi \


.PHONY: h
h:
	@echo 'make [OPTIONS...] [TARGETS...]'
	@echo
	@echo 'TARGETS:'
	@echo
	@echo 'all'
	@echo '   The default target that CMake generates'
	@echo
	@echo '<other>'
	@echo '    Any other targets generated by CMake'
	@echo
	@echo
	@echo 'OPTIONS:'
	@echo
	@echo 'BUILD_TYPE=<Debug|Release>'
	@echo '    specifies the CMake build type'
	@echo '    default: Debug'
	@echo
	@echo 'BUILD_TOOL=<ninja|make>'
	@echo '    Specifies the cmake generator'
	@echo '    default: ninja'
	@echo
	@echo 'CLANG_TIDY_FIX=<ON|OFF>'
	@echo '    Specifies if clang-tidy should run fixits or not'
	@echo '    default: OFF'
	@echo
	@echo 'INSTALL_PREFIX=<path>'
	@echo '    Specifies the CMAKE_INSTALL_PREFIX CMake variable value'
	@echo '    default when BUILD_TYPE is Debug: ./build/debug/install'
	@echo '    default when BUILD_TYPE is Release: ./build/release/install'
	@echo
	@echo '-j <jobs>'
	@echo '    <jobs> is used to set the $$JOBS environemnt variable'
	@echo '    default: '''
	@echo
	@echo 'EXAMPLES:'
	@echo
	@echo 'make BUILD_TYPE=Release all -j8'
	@echo 'make target'
